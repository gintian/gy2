var $jscomp={scope:{},findInternal:function(g,n,u){g instanceof String&&(g=String(g));for(var t=g.length,k=0;k<t;k++){var l=g[k];if(n.call(u,l,k,g))return{i:k,v:l}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(g,n,u){if(u.get||u.set)throw new TypeError("ES3 does not support getters and setters.");g!=Array.prototype&&g!=Object.prototype&&(g[n]=u.value)};
$jscomp.getGlobal=function(g){return"undefined"!=typeof window&&window===g?g:"undefined"!=typeof global?global:g};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(g,n,u,t){if(n){u=$jscomp.global;g=g.split(".");for(t=0;t<g.length-1;t++){var k=g[t];k in u||(u[k]={});u=u[k]}g=g[g.length-1];t=u[g];n=n(t);n!=t&&null!=n&&$jscomp.defineProperty(u,g,{configurable:!0,writable:!0,value:n})}};
$jscomp.polyfill("Array.prototype.find",function(g){return g?g:function(g,u){return $jscomp.findInternal(this,g,u).v}},"es6-impl","es3");
var CryptoJS=CryptoJS||function(g,n){var u={},t=u.lib={},k=t.Base=function(){function q(){}return{extend:function(l){q.prototype=this;var e=new q;l&&e.mixIn(l);e.hasOwnProperty("init")||(e.init=function(){e.$super.init.apply(this,arguments)});e.init.prototype=e;e.$super=this;return e},create:function(){var e=this.extend();e.init.apply(e,arguments);return e},init:function(){},mixIn:function(e){for(var l in e)e.hasOwnProperty(l)&&(this[l]=e[l]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},
clone:function(){return this.init.prototype.extend(this)}}}(),l=t.WordArray=k.extend({init:function(e,l){e=this.words=e||[];this.sigBytes=l!=n?l:4*e.length},toString:function(e){return(e||A).stringify(this)},concat:function(e){var l=this.words,k=e.words,q=this.sigBytes;e=e.sigBytes;this.clamp();if(q%4)for(var g=0;g<e;g++)l[q+g>>>2]|=(k[g>>>2]>>>24-g%4*8&255)<<24-(q+g)%4*8;else if(65535<k.length)for(g=0;g<e;g+=4)l[q+g>>>2]=k[g>>>2];else l.push.apply(l,k);this.sigBytes+=e;return this},clamp:function(){var e=
this.words,l=this.sigBytes;e[l>>>2]&=4294967295<<32-l%4*8;e.length=g.ceil(l/4)},clone:function(){var e=k.clone.call(this);e.words=this.words.slice(0);return e},random:function(e){for(var k=[],q=0;q<e;q+=4)k.push(4294967296*g.random()|0);return new l.init(k,e)}}),w=u.enc={},A=w.Hex={stringify:function(e){var l=e.words;e=e.sigBytes;for(var k=[],g=0;g<e;g++){var q=l[g>>>2]>>>24-g%4*8&255;k.push((q>>>4).toString(16));k.push((q&15).toString(16))}return k.join("")},parse:function(e){for(var k=e.length,
g=[],q=0;q<k;q+=2)g[q>>>3]|=parseInt(e.substr(q,2),16)<<24-q%8*4;return new l.init(g,k/2)}},F=w.Latin1={stringify:function(e){var l=e.words;e=e.sigBytes;for(var k=[],g=0;g<e;g++)k.push(String.fromCharCode(l[g>>>2]>>>24-g%4*8&255));return k.join("")},parse:function(e){for(var k=e.length,g=[],q=0;q<k;q++)g[q>>>2]|=(e.charCodeAt(q)&255)<<24-q%4*8;return new l.init(g,k)}},e=w.Utf8={stringify:function(e){try{return decodeURIComponent(escape(F.stringify(e)))}catch(x){throw Error("Malformed UTF-8 data");
}},parse:function(e){return F.parse(unescape(encodeURIComponent(e)))}},D=t.BufferedBlockAlgorithm=k.extend({reset:function(){this._data=new l.init;this._nDataBytes=0},_append:function(l){"string"==typeof l&&(l=e.parse(l));this._data.concat(l);this._nDataBytes+=l.sigBytes},_process:function(e){var k=this._data,q=k.words,n=k.sigBytes,t=this.blockSize,A=n/(4*t),A=e?g.ceil(A):g.max((A|0)-this._minBufferSize,0);e=A*t;n=g.min(4*e,n);if(e){for(var u=0;u<e;u+=t)this._doProcessBlock(q,u);u=q.splice(0,e);k.sigBytes-=
n}return new l.init(u,n)},clone:function(){var e=k.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});t.Hasher=D.extend({cfg:k.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){D.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){e&&this._append(e);return this._doFinalize()},blockSize:16,_createHelper:function(e){return function(l,k){return(new e.init(k)).finalize(l)}},_createHmacHelper:function(e){return function(l,
k){return(new B.HMAC.init(e,k)).finalize(l)}}});var B=u.algo={};return u}(Math);
(function(){var g=CryptoJS,n=g.lib,u=n.WordArray,t=n.Hasher,k=[],n=g.algo.SHA1=t.extend({_doReset:function(){this._hash=new u.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(l,g){for(var n=this._hash.words,u=n[0],e=n[1],t=n[2],w=n[3],q=n[4],x=0;80>x;x++){if(16>x)k[x]=l[g+x]|0;else{var y=k[x-3]^k[x-8]^k[x-14]^k[x-16];k[x]=y<<1|y>>>31}y=(u<<5|u>>>27)+q+k[x];y=20>x?y+((e&t|~e&w)+1518500249):40>x?y+((e^t^w)+1859775393):60>x?y+((e&t|e&w|t&w)-1894007588):y+((e^t^
w)-899497514);q=w;w=t;t=e<<30|e>>>2;e=u;u=y}n[0]=n[0]+u|0;n[1]=n[1]+e|0;n[2]=n[2]+t|0;n[3]=n[3]+w|0;n[4]=n[4]+q|0},_doFinalize:function(){var l=this._data,k=l.words,g=8*this._nDataBytes,n=8*l.sigBytes;k[n>>>5]|=128<<24-n%32;k[(n+64>>>9<<4)+14]=Math.floor(g/4294967296);k[(n+64>>>9<<4)+15]=g;l.sigBytes=4*k.length;this._process();return this._hash},clone:function(){var l=t.clone.call(this);l._hash=this._hash.clone();return l}});g.SHA1=t._createHelper(n);g.HmacSHA1=t._createHmacHelper(n)})(this);
(function(g,n){"function"!==typeof define||!define.amd||"undefined"!=typeof nonUseAmd&&nonUseAmd?n():"undefined"!=typeof HTMLDev&&HTMLDev?define(["./core/kinggrid.plus"],n):define(["./core/kinggrid.plus.min"],n)})(window,function(g){function n(a){a=JSON.stringify(a);return A?a.replace(/\\u([0-9a-fA-F]{2,4})/g,function(a,c){return String.fromCharCode(parseInt(c,16))}):a}function u(a,b,c){var f=[],m={},h;for(h in a){var r={},p=a[h];e.is("String",p)&&(A||0!=p.indexOf("ey"))?(r["b64_"+h]=a[h],f.push(r)):
m[h]=p}var l=[];(function(a){for(var b in a)l.push((new d(b,a[b])).load(d.options))})(m);if(a=f.length)for(m=d.options.signSize||5,h=Math.ceil(a/m),r=1;r<=h;r++){var p=m*(r-1),g=m*r>a?a:m*r;G=k.surry(d.options.serverUrl);G.request(d.options.b64Url,f.slice(p,g)).ret(function(a){if(a.result)for(var b in a){if(0==b.indexOf("b64_")){var c=a[b];e.is("String",c)&&(c=JSON.parse(c));l.push((new d(b.substring(4),c)).load(d.options))}}else d.prototype.error.call(null,a)})}G.fin(function(a,f,d){b&&b(1==l.length?
l[0]:l);c&&c()})}var t=window,k=window.kinggrid,l=window.jQuery,w=window.kingPlus,A=!1;t.JSON&&(A='{"x":"\u4e2d"}'!==t.JSON.stringify({x:"\u4e2d"}));var F=!0;try{t.document.createElement("canvas").getContext("2d")}catch(a){F=!1}var e=k.Utils,D=l(window),B=l(document);g=document.documentElement;var q=!!("minWidth"in g.style)&&"onlosecapture"in g,x="setCapture"in g,y,C,L=function(a){y&&(a=a.originalEvent?a.originalEvent.touches.item(0):a.touches.item(0));return a},K=function(a){this.start=l.proxy(this.start,
this);this.over=l.proxy(this.over,this);this.end=l.proxy(this.end,this);this.onstart=this.onover=this.onend=l.noop;C||(y="mousedown"!=a.type,C={start:y?"touchstart":"mousedown",over:y?"touchmove":"mousemove",end:y?"touchend":"mouseup"})};K.prototype={start:function(a){a=this.startFix(a);z.trigger("dragStart",this,a);B.on(C.over,this.over).on(C.end,this.end);this.onstart(a);return!1},over:function(a){a=this.overFix(a);z.trigger("dragOver",this,a);this.onover(a);return!1},end:function(a){a=this.endFix(a);
z.trigger("dragEnd",this,a);B.off(C.over,this.over).off(C.end,this.end);this.onend(a);return!1},startFix:function(a){a=L(a);this.target=l(a.target);this.selectstart=function(){return!1};B.on("selectstart",this.selectstart).on("dblclick",this.end);if(q)this.target.on("losecapture",this.end);else D.on("blur",this.end);x&&this.target[0].setCapture();return a},overFix:function(a){return a=L(a)},endFix:function(a){a=L(a);B.off("selectstart",this.selectstart).off("dblclick",this.end);q?this.target.off("losecapture",
this.end):D.off("blur",this.end);x&&this.target[0].releaseCapture();return a}};K.create=function(a,b,c){var f=l(a),d=new K(b),h=C.start,r=function(){},p=a.className.replace(/^\s|\s.*/g,"")+"-drag-start",e=f[0].style,k,M,g,n,t=0,q=0,N=parseInt(e.left),O=parseInt(e.top),u=N,v=O,w=N,x=O;c&&(u=parseInt(e.marginLeft),v=parseInt(e.marginTop),w=u,x=v);var y={onstart:r,onover:r,onend:r,off:function(){f.off(h,d.start)}};d.onstart=function(b){var c="fixed"===f.css("position"),d=B.scrollLeft(),m=B.scrollTop(),
h=f.width(),e=f.height();M=k=0;g=c?D.width()-h+k:B.width()-h;n=c?D.height()-e+M:B.height()-e;e=f.offset();h=this.startLeft=c?e.left-d:e.left;c=this.startTop=c?e.top-m:e.top;this.clientX=b.clientX;this.clientY=b.clientY;e=f.parent();e.is("body")||(t=e[0].getBoundingClientRect().left+d,q=e[0].getBoundingClientRect().top+m);f.addClass(p);y.onstart.call(a,b,h,c)};d.onover=function(b){var d=b.clientX-this.clientX+this.startLeft,m=b.clientY-this.clientY+this.startTop,h=f[0].style,d=Math.max(k,Math.min(g,
d)),m=Math.max(M,Math.min(n,m));c?(d=h.marginLeft=d-t-N+"px",m=h.marginTop=m-q-O+"px"):(d=h.left=d-t+"px",m=h.top=m-q+"px");w=parseInt(d);x=parseInt(m);y.onover.call(a,b,d,m)};d.onend=function(b){var d=f.position(),m=d.left,d=d.top;f.removeClass(p);var h=f[0].style,e=!0;6>Math.abs(w-u)&&6>Math.abs(x-v)&&(e=!1);c?y.onend.call(a,b,e,h.marginLeft,h.marginTop):y.onend.call(a,b,e,m,d)};d.off=function(){f.off(h,d.start)};if(b)d.start(b);else f.on(h,d.start);return y};g=k.Listener;var E=function(){};l.extend(E.prototype,
g.prototype);var H=function(){};H.className=H.name||"SealService";e.inherit(H,E);l.extend(H.prototype,{loadSeal:function(){throw Error("must impl");},saveLog:function(){},verifyPwd:function(){throw Error("must impl");}});var I=function(){};I.className=I.name||"CertService";e.inherit(I,E);l.extend(I.prototype,{sign:function(){throw Error("must impl");},verifySign:function(){throw Error("must impl");}});E=function(){};l.extend(E.prototype,{getAttr:function(a){return this[a]},setAttr:function(a){var b=
this;l.each(a,function(a,f){if("function"===typeof b[a])b[a](f);else b[a]=f})},removeAttr:function(a){delete this[a]}});var d=function(a,b){var c=this;c.signatureid=a;c.setSignatureData(b);c.on("load",function(){d.list[a]=this});c.on("remove",function(a){a=c._getLogInfo(e.extend(a||{},{LOGTYPE:"00",LOGSORT:"14",LOGMEMO:"\u64a4\u9500\u7b7e\u7ae0\u6210\u529f"}));c.sealService.saveLog(a);delete d.list[c.signatureid]});c.on("update",function(a){"signMeta"===c._item&&(a=c._getLogInfo(e.extend(a||{},{LOGTYPE:"00",
LOGSORT:"304",LOGMEMO:"\u6570\u5b57\u7b7e\u540d\u6210\u529f"})),c.sealService.saveLog(a))});c.on("fireremove",function(){d.removeList.push(c.signatureid)});c.on("fireupdate",function(){for(var a=!1,b=0;b<d.updateList.length;b++)if(d.updateList[b]===c){a=!0;break}a||d.updateList.push(c)});for(var f in d)d.hasOwnProperty(f)&&0==f.indexOf("on")&&(this[f]=d[f]);return this},P=function(a,b,c){var f;if(F){f=t.document.createElement("canvas");f.height=c;f.width=b;var d=f.getContext("2d"),h=new Image;h.src=
a;h.onload=function(){d.drawImage(h,0,0,b,c)}}else f=t.document.createElement("img"),f.style.width=b+"px",f.style.height=c+"px",f.setAttribute("src",a);return f};e.inherit(d,E);l.extend(d.prototype,g.prototype);l.extend(d.prototype,{hashAlg:"sha1",encryptAlg:"RSA",_init:function(){},_getLogInfo:function(a){var b=decodeURIComponent(window.location.href),c=this.signatureData;return e.extend(a||{},{KEYSN:c.keysn,SIGNSN:c.seal.signsn,DOCUMENTID:c.documentid,DOCUMENTNAME:c.documentname,APPVERSION:Q.name,
APPTYPE:"HTML",APPCODE:this.appcode,EXTPARAM2:b})},error:function(a,b,c){var f=a;e.is("Object",a)&&(f=a.errcode&&"511"!=a.errcode?a.errcode:a.errmsg);f||(f="-999");b=e.is("String",b)?b:"then";d.options.errorCall?(v.hideLoading(),d.options.errorCall.call(null,a,b)):v.alert(k.msg(f,b),function(){v.hideLoading();return e.is("Function",c)?c():!0})},load:function(a){this.trigger("beforeLoad");this.setAttr(a);this.certService=new d.factory.cert[d.options.certType](a,this.signatureData);var b=this.signatureData;
void 0!==a.extra&&null!==a.extra&&void 0!==a.extra[this.signatureid]?(void 0!==a.extra[this.signatureid].scaleImage&&null!==a.extra[this.signatureid].scaleImage&&(b.seal.height*=a.extra[this.signatureid].scaleImage,b.seal.width*=a.extra[this.signatureid].scaleImage),void 0!=a.extra[this.signatureid].position&&(this.removeItem(b.position),this.updatePos(a.extra[this.signatureid].position,{marginLeft:a.extra[this.signatureid].offsetX,marginTop:a.extra[this.signatureid].offsetY}))):void 0!==a.scaleImage&&
null!==a.scaleImage&&(b.seal.height*=a.scaleImage,b.seal.width*=a.scaleImage);this.sealService=new d.factory.seal[d.options.sealType](a,b);this._init();this.trigger("load");return this},toBase64Img:function(a){var b=a.imgdata,c=b.indexOf(a.signsn);if(-1==c)return b;b=a.imgdata.substring(c+65);return e.Base64.of().encodeByte(e.Base64.of(a.signsn).decodeByte(b))},clearImg:function(){if(this.imgEles)for(var a in this.imgEles)this.trigger("removeAt",this.imgEles[a][0]),this.imgEles[a].remove();this.imgEles=
{}},repaint:function(){this.clearImg();this.verify()},getUpdateType:function(){return this._item},updatePos:function(a,b){var c=this.signatureData.position[a];this._item="position";this.signatureData.position[a]=e.extend({},c,b)},updateItem:function(a,b){this._item=a;this.signatureData[a]=b},removeItem:function(a){for(var b in a)delete a[b]},fireUpdate:function(a){var b=this,c=function(c){a&&a(c);b[c?"update":"restore"]();delete b._item};d.asyn.update?d.asyn.update.call(b,c):(this.trigger("fireupdate"),
c(!0));return this},restore:function(){this.setSignatureData(this.oriSignatureData);this.repaint()},update:function(){this.setSignatureData(this.signatureData);this.repaint();this.trigger("update");return this},remove:function(){this.clearImg();this.trigger("remove");for(var a in this)delete this[a];return this},fireRemove:function(a){var b=this,c=function(c){a&&a(c);c&&b.remove()};d.asyn.remove?d.asyn.remove.call(b,c):(this.trigger("fireremove"),c(!0));return this},hide:function(){if(this.imgEles)for(var a in this.imgEles)this.imgEles[a].hide()},
createImg:function(){var a=this.signatureData,b=l(document.createElement("img")),c="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=";this.broken||(c="data:image/"+a.seal.imgext+";base64,"+this.toBase64Img(a.seal));b.css({width:Math.ceil(9600*parseFloat(a.seal.width)/254),height:Math.ceil(9600*parseFloat(a.seal.height)/254)}).attr({src:c});return b},show:function(){var a=this.signatureData.position,b=this.imgEles=this.imgEles||{},c;
for(c in a){var f="kg-img-div-"+this.signatureid+"-"+c,d=b[f];d||(d=b[f]=this.showAt(c,a[c]));this._handleImg(d)}this.trigger("show")},showAt:function(a,b){this.trigger("beforeShowAt",a,b);var c=e.$(a),f=l(c);this.extra&&this.extra[this.signatureid]&&(c=this.extra[this.signatureid].scopePosition)&&(f=c instanceof Object?c.find("#"+a):l(e.$(c)).find("#"+a));if(0==f.length)if(d.options.defaultPos)a=d.options.defaultPos,f=l(e.$(a));else throw Error("no find position:"+a+" signatureid="+this.signatureid);
var m=this.createImg();m.addClass("kg-img").attr("id","kg-img-"+this.signatureid);c=l(document.createElement("div")).addClass("kg-img-div").addClass("kg-img-div-"+a).attr({id:"kg-img-div-"+this.signatureid+"-"+a,elemid:a,signatureid:this.signatureid});c.append(m);c.css({width:m.width(),height:m.height()});var h=0,r=0,p=this.signatureData.dateTime;null!=p&&p.isCheck&&p.fontDate&&(this.addDateToImg(p.fontDate,this.signatureData.timestamp.time,c),null!=this.imageAndDate&&this.imageAndDate&&"outside"==
p.fontDate.fontPosition[2]&&("right"==p.fontDate.fontPosition[3]?h+=c.width():"left"==p.fontDate.fontPosition[3]&&(h+=c.width()),"below"==p.fontDate.fontPosition[4]&&(r+=c.height())));c.css({width:m.width()+h,height:m.height()+r});m=c;h="kg-default";if(p=f.attr("display"))f.addClass("display-"+p),h="kg-"+p,r=f,m=document.getElementById("kg-img-container-"+a),m||(m=document.createElement("div"),m.setAttribute("id","kg-img-container-"+a)),m=l(m).addClass(h+"-container"),m.append(c),c.attr("kg-display",
!0);else if(r=f.offsetParent(),"html"==r[0].tagName.toLowerCase()||"relative"==r[0].style.position)r=l("body");c.addClass(h);r.append(m);if(p){if("landscape"===p){var f=m.children(),h=m.parent().width(),k=0;f.each(function(){k+=parseInt(l(this).width())+1});m.width(k>h?k:h)}}else this.calSealPos(f,c,m,b);this.trigger("showAt",c[0],a,b);return c},calSealPos:function(a,b,c,f){var d=a.offsetParent();c=c||b;if("html"==d[0].tagName.toLowerCase()||"relative"==d[0].style.position)d=l("body");a=a.offset();
var h=d.offset();d.is("body")&&(h={top:0,left:0});c.css({top:a.top-h.top,left:a.left-h.left});f?(d=f.marginLeft,f=f.marginTop):(d=b.css("marginLeft"),f=b.css("marginTop"));b.css({marginLeft:d||0,marginTop:f||0})},addDateToImg:function(a,b,c){b=k.Utils.formatDate(new Date(b),a.fontFormat);var f=l(document.createElement("div")).addClass("kg-date"),d=0,h=0;"outside"==a.fontPosition[2]&&("right"==a.fontPosition[3]?d+=c.width():"left"==a.fontPosition[3]&&(d-=c.width()),"below"==a.fontPosition[4]&&(h+=
c.height()));f.css({width:c.width(),height:c.height(),top:h,left:d});d=l(document.createElement("div")).addClass("kg-date-tmb").css({width:c.width()});h=l(document.createElement("div")).addClass("kg-date-lcr").css({"text-align":a.fontPosition[0],"font-family":a.fontFamily,"font-size":a.fontSize+"px",color:a.fontColor});"bottom"==a.fontPosition[1]?d.css({bottom:0}):"middle"==a.fontPosition[1]&&h.css({"line-height":c.height()+"px"});h.html(b);d.html(h);f.html(d);c.append(f)},canSign:function(){return!this.modified&&
!d.options.readonly&&d.options.signable&&!this.signatureData.signMeta},canMove:function(a){(a=!d.options.readonly&&this.signatureData.moveable&&d.options.moveable&&!l(a).attr("kg-display"))&&d.options.moveable_self&&(a=this.signatureData.keysn==d.options.keysn);return a},canDelete:function(){return!d.options.readonly},_handleImg:function(a){a.show();if(0==a.children(".kg-shade").length){var b=l(document.createElement("div")).addClass("kg-shade");b.append(P("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=",
a.width(),a.height()));a.append(b)}this._invalid(a);this.trigger("handleImg",a[0])},setSignatureData:function(a){e.is("String",a)?this.signatureData=JSON.parse(e.Base64.of().decode(a)):this.signatureData=a;this.oriSignatureData=JSON.parse(JSON.stringify(this.signatureData))},getSignatureid:function(){return this.signatureid},getSignatureData:function(){var a=JSON.stringify(this.signatureData);return e.Base64.of().encode(a)},getBase64Image:function(a,b,c,f){c="kg-img-div-"+a+"-"+c;c=document.getElementById(c);
null!=c&&(A?f(this,"",a,b):html2canvas(c).then(function(c){c=c.toDataURL("image/png").split(",");f(this,c,a,b)}))},_invalid:function(a){var b=a.children(".kg-invalid");if(0==b.length){b=l(document.createElement("div")).addClass("kg-hide").addClass("kg-invalid");a.append(b);var c=a.height()/3;b.css({top:c,height:c});for(var c=c/3,f=a.width(),d=0;3>d;d++){var h=l(document.createElement("div")).height(c);0==d%2&&(h.addClass("kg-invalid-item"),h.append(P("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mNoaGgAAAMEAYF1LgG8AAAAAElFTkSuQmCC",
f,c)));b.append(h)}}if(this.modified){c="";for(f=0;f<this.modifiedItems.length;f++)d=this.modifiedItems[f],c+=d.desc+"["+d.field+"]\u7531{"+d.orivalue+"}\u66f4\u6539\u4e3a{"+d.newvalue+"};";a.attr("modified",c).addClass("error");b.removeClass("kg-hide")}else a.removeAttr("modified").removeClass("error"),b.addClass("kg-hide")},_verify:function(a,b){this.trigger("before_verify");var c=this.verifyProtectedData(a);if(!b||b&&b.batchVerify||null==this.oriSignatureData.timestamp.timestampInfo)return this.show(),
this.trigger("_verify"),!c;var d=this;this.getVerifyTimeStamp(this.oriSignatureData.timestamp.timestampInfo,function(a){d.timeVerify=a;d.show();d.trigger("_verify");b&&b.sucCall&&b.sucCall.call(d)})},verify:function(a,b){this.trigger("beforeVerify");var c=this._verify(a,b);this.trigger("verify");return c},getVerifyProtectedData:function(){for(var a=this.validatedData,b=this.signatureData.protectedData,c={},d=0;d<b.length;d++){var m=b[d],h=m.field,r=a&&a[h];if(!r){var p=e.$(h);if(p){if(r=p.getAttribute("kg-value")||
p.value,void 0===r||null===r)r=p.innerHTML||p.innerText}else r=void 0!=m.name&&null!=m.name?document.getElementById(m.name).value:""}m=e.val(r,this);m=this._formatValue(m);c[h]=m}return c},getSignTimeStamp:function(a){for(var b={},c=0;c<a.length;c++)b[a[c].field]=a[c].value;return e.Base64.of().encode(n(b))},getValidatedTimeStamp:function(){var a=this.getVerifyProtectedData(),a=n(a);return e.Base64.of().encode(a)},getVerifyTimeStamp:function(a,b){var c=this.getValidatedTimeStamp(),f=a.CertData,m=
k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");m.invoke("SetParamByName","TSCERTDATA",e.Base64.of().encode(f)).ret(function(){m.invoke("KGVerifyTSWithReq",a.TimeStampResponse,a.TimeStampResult,"",c,a.TimeStr,"").ret(function(a){b.call(this,a.result)})})},getH5SignData:function(){var a=this.hashAlg,b=this.encryptAlg,c=CryptoJS.SHA1(this.getSignData()).toString();return[{hashAlg:a,encryptAlg:b,signdata:c}]},verifyProtectedData:function(a){a&&(this.validatedData=
a);a=[];for(var b=this.getVerifyProtectedData(),c=this.signatureData.protectedData,d=0;d<c.length;d++){var m=c[d],h=b[c[d].field];h!==m.value&&a.push({field:m.field,desc:m.desc,orivalue:m.value,newvalue:h})}this.modified=0<a.length;this.modifiedItems=a;return this.modified},verifySignData:function(a){var b=this;v.showLoading();var c=this.certService,f;if(this.signatureData.signMeta.html2sign){c instanceof J||(c=new J(d.options),c.sData=b.signatureData);f=b.getVerifyProtectedData();for(var m=this.signatureData.protectedData,
h=[],e=0;e<m.length;e++){var p=m[e],k={},g;for(g in p)p.hasOwnProperty(g)&&(k[g]=p[g]);k.value=f[p.field];h.push(k)}f=n(h)}else f=this.getValidatedSignData();c.verifySign(l.extend({signeddata:this.signatureData.signMeta.signeddata,crtdata:this.signatureData.signMeta.certinfo.crtdata,keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,signdata:f},{successCall:function(c){v.hideLoading();var d;c.errcode||(b.signModified=!c.result,d=b.verify(null,{sucCall:function(){a&&a(c)}}));null!=
d&&a&&a(c)}}))},_renderValue:function(a){return a.replace(/\r\n/ig,"<br>")},_formatValue:function(a,b){var c=a;c&&(c=c.replace(/\r\n/ig,"\n"),c=c.replace(/\n/ig,"\r\n"));return c},getItemVal:function(a){var b;if(b=e.is("String",a)?e.$(a):a)return a=b.tagName.toLowerCase(),"input"===a||"textarea"===a||"select"===a||"div"===a?b.getAttribute("kg-value")||b.value:b.getAttribute("kg-value")||(A?b.innerText:b.textContent);throw Error("No find protectedItem:"+a+" signatureid="+this.signatureid);},getProtectedData:function(a){var b=
this,c=[],d=function(a){var c=e.$(a);if(c){var d={field:a};d.desc=c.getAttribute("kg-desc")||a;d.value=b.getItemVal(c);return d}throw Error("No find protectedItem:"+a+" signatureid="+this.signatureid);},m=function(a){if(e.is("String",a))a=d(a);else if(!e.is("Object",a)||!a.field)throw Error("Unsupported protectedItems:"+a.toString);e.is("Function",a.value)&&(a.value=a.value.call(b,a.field,a.desc));a.value=b._formatValue(a.value);return a};if(a)if(e.is("Array",a))for(var h=0,r=a.length;h<r;h++)c.push(m(a[h]));
else c.push(m(a));return c},__findSignedData:function(a){if(e.is("String",a))return a.split(";")[0];if(e.is("Array",a))return a[0];throw Error("error signeddata: "+a);},getValidatedSignData:function(){var a=this.getVerifyProtectedData(),a=n(a),a=e.Base64.of().encode(a);return CryptoJS.SHA1(a).toString()},getSignData:function(a){a=(a||this.signatureData).protectedData;for(var b={},c=0;c<a.length;c++)b[a[c].field]=a[c].value;return e.Base64.of().encode(n(b))},showSignSignatureDialog:function(a){var b=
{target:e.is("Array",a.target)?a.target:[a.target],title:k.msg("SignSignature","KG_TITLE"),onShow:function(){var a=this;setTimeout(function(){a.find("#kg-password").focus()},40);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onOk:function(){var b=this.find("#kg-password");if(!b.val())return v.alert(k.msg("in_pwd_msg","KG_MSG"),function(){b.focus()}),!1;a._onOk.call(this,b.val());return!1}};return this.showDialog("signSignatureBtl",b)},signSignature:function(a){var b=
this;return b.showSignSignatureDialog({target:b,_onOk:function(c){var d=this,m=b.getH5SignData();b.runSign(m,c,function(c){c.result?b.fireUpdate(function(a){a&&d.remove()}):b.error(c);a&&a(c)})}})},showRevokeSignatureDialog:function(a){var b={target:e.is("Array",a.target)?a.target:[a.target],title:k.msg("RevokeSignature","KG_TITLE"),onShow:function(){var a=this;setTimeout(function(){a.find("#kg-password").focus()},40);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},
onOk:function(){var b=this.find("#kg-password");if(!b.val())return v.alert(k.msg("in_pwd_msg","KG_MSG"),function(){b.focus()}),!1;a._onOk.call(this,b.val());return!1}};return this.showDialog("revokeSignatureBtl",b)},revokeSignature:function(a){var b=this,c={target:b,_onOk:function(c){var f=this;v.showLoading();b.sealService.verifyPwd({pwd:c,keysn:b.signatureData.keysn,successCall:function(c){v.hideLoading();c.result?void 0!==d.options.delCallBack&&d.options.delCallBack?d.options.delCallBack(b.signatureid,
b.signatureData)&&b.fireRemove(function(a){a&&(f.remove?f.remove():b.remove())}):b.fireRemove(function(a){a&&(f.remove?f.remove():b.remove())}):b.error(c);a&&a(c)}})}};if(d.options.showNoPW&&"server"==d.options.sealType)c._onOk(d.options.password);else return b.showRevokeSignatureDialog(c)},showDialog:function(a,b){var c=e.is("Array",b.target)?b.target:[b.target],f={title:k.msg("KinggridSignature","KG_TITLE"),onCancel:b.errCall||function(){v.hideLoading();return!0},content:function(){var b=[d.options.template[a]].concat(c);
return e.template.apply(null,b)}},f=e.extend(f,b),f=v.showDialog(a,f);if("showSealsBtl"===a){var m=f.find("#sealTpl-dialog"),h=!1,r=0,p=0,l=0,g=0;m.prevObject[0].onmousedown=function(a){h=!0;a=a||event;r=a.clientX;p=a.clientY;l=parseInt(m.prevObject[0].style.top);g=parseInt(m.prevObject[0].style.left)};m.prevObject[0].onmousemove=function(a){if(h){a=a||event;var b=g+a.clientX-r;a=l+a.clientY-p;0<b&&0<a&&(m.prevObject[0].style.left=b+"px",m.prevObject[0].style.top=a+"px")}};m.prevObject[0].onmouseup=
function(a){h&&(h=!1,g=l=p=r=0)}}return f},runMove:function(a,b,c){var f=this;z.trigger("startMove",f,a,b);return"client"==d.options.sealType&&d.options.moveable_self&&f.keysn!=f.signatureData.keysn?(d.alert(k.msg("cannot_move","KG_MSG")),!1):function(a,b,c){b=K.create(b,a,!0);b.onend=function(a,b,d,h){c&&c(b,d,h);z.trigger("endMove",f,a,d,h);b&&(a=l(this),f.updatePos(a.attr("elemid"),{marginLeft:d,marginTop:h}),f.fireUpdate())};a.preventDefault();return b}(a,b,c)},runSign:function(a,b,c){var f=this,
m=f.signatureData;v.showLoading();f.certService.sign({keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,password:b,signMeta:a,successCall:function(b){v.hideLoading();b.result&&(b.signeddata?(b.certinfo.algName=b.certinfo.algName.toUpperCase(),f.updateItem("signMeta",{hashAlg:a[0].hashAlg,encryptAlg:a[0].encryptAlg,signdata:a[0].signdata,signeddata:f.__findSignedData(b.signeddata),certinfo:b.certinfo})):(b.result=!1,b.errcode="signErr"),m.certType=d.options.certType);c&&c(b)}})}});
var v=w();d.options=l.extend({b64Url:"/iWebSignature_base64",imageUrl:"/iWebSignature_image"},k.options,{dialogConfig:{okValue:"\u786e  \u5b9a",cancelValue:"\u53d6  \u6d88",fixed:!0,backdropOpacity:.2,modal:!0},template:{}},window.KGCONFIG);d.addProvider=function(a,b,c){d.factory[a][b]=c};var G;d.init=function(a,b){this.Seals={};e.extend(d.options,a);var c=d.options;b=b?b:a.okCall;c.serverUrl&&(c.b64Url="/signature/b64",c.imageUrl="/signature/image",c.serverUrl+="/rest");"client"==c.sealType?(c.clientUrl=
c.https,G=d.aisleKing=k.surry(c.clientUrl?c.clientUrl:"http://127.0.0.1:9581","IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319")):G=d.aisleKing=k.surry(c.serverUrl||c.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");var f=c.clientConfig;f&&"client"===c.sealType?d.AXI("SetParamByName",f,b):b&&b.call();z.trigger("init")};d.factory={cert:{},seal:{}};d.SealService=H;d.CertService=I;d.asyn={};d._create=function(a){var b=this;b.setAttr(a);b.certService=new d.factory.cert[b.certType](a);
b.sealService=new d.factory.seal[b.sealType](a);b.on("createSignature",function(a,d,m){a=[];var c=b._getLogInfo({LOGTYPE:"00",LOGSORT:"13",LOGMEMO:"\u76d6\u7ae0\u6210\u529f",LOGSORTSUBCLASS:"1301"});a.push(e.extend(d||{},c));m&&a.push(b._getLogInfo({LOGTYPE:"00",LOGSORT:"304",LOGMEMO:"\u6570\u5b57\u7b7e\u540d\u6210\u529f"}));b.sealService.saveLog(a)});return this};w=function(){};w.prototype=d.prototype;w=new w;d._create.prototype=w;l.extend(w,{keyData:null,sealExpired:function(a,b,c,f,m){var h=this,
e=!0;if(void 0===d.options.valid||null===d.options.valid||!1===d.options.valid)return h.certExpired(b,c,f);if(void 0!==a.endata&&null!==a.endata){var p=a.endata;m=parseInt(c.substr(0,4));a=parseInt(c.substr(5,2));var e=parseInt(c.substr(8,2)),k=parseInt(p.substr(0,4)),g=parseInt(p.substr(5,2)),p=parseInt(p.substr(8,2));m>k?(h.errorCallback({errcode:"11104"},b.errorCall),e=!1):m==k?a>g?(h.errorCallback({errcode:"11104"},b.errorCall),e=!1):a==g?e>p?(h.errorCallback({errcode:"11104"},b.errorCall),e=
!1):e=!0:e=!0:e=!0}else return a=d.options.serverUrl+"/key/SealIsExpired",m=(parseInt(m)+1).toString(),l.ajax({url:a,data:{keysn:h.keyData.keysn,year:(new Date).getFullYear(),month:(new Date).getMonth(),date:(new Date).getDate(),index:m},async:!1,success:function(a){if(a.error)return h.errorCallback({errcode:"11105"},b.errorCall),!1;if(0==a.result)return h.certExpired(b,c,f);h.errorCallback({errcode:"11104"},b.errorCall);return!1},error:function(a){h.errorCallback({errcode:"11105"},b.errorCall)}}),
!1;return e?h.certExpired(b,c,f):e},certExpired:function(a,b,c){var f=this,e=!1;if(void 0===d.options.valid||null===d.options.valid||!1===d.options.valid)return!0;k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGGetCerInfo","").ret(function(d){var m=parseInt(b.substr(0,4)),h=parseInt(b.substr(5,2)),k=parseInt(b.substr(8,2));if(d.result){d=d.certinfo.notAfter;var l=parseInt(d.substr(0,4)),g=parseInt(d.substr(4,1)),g=0==g?parseInt(d.substr(5,
1)):parseInt(d.substr(4,2)),n=parseInt(d.substr(6,1)),n=0==n?parseInt(d.substr(7,1)):parseInt(d.substr(6,2));m>l?f.errorCallback({errcode:"11103"},a.errorCall):m==l?h>g?f.errorCallback({errcode:"11103"},a.errorCall):h==g?k>n?f.errorCallback({errcode:"11103"},a.errorCall):e=!0:e=!0:e=!0}else f.errorCallback({errcode:"11106"},a.errorCall);void 0!==c&&null!==c&&c(e)});return e},errorCallback:function(a,b,c){b?(v.hideLoading(),b.call(null,a,c)):this.error(a,c)},runHW:function(a,b){var c=this;v.showLoading();
"undefined"!=typeof a.imageData&&null!=a.imageData&&(void 0!==a.beginCall&&a.beginCall&&a.beginCall.call(c),c.sealService.loadSeal({data:a.imageData,successCall:function(d){v.hideLoading();if(d.result&&d.seals){for(var f in d.seals){d.seals=[{width:a.width,height:a.height,imgext:d.seals[f].imgext,signname:a.name,signsn:d.seals[f].signsn,username:d.seals[f].username,imgdata:a.imageData,headinfoex:d.seals[f].headinfoex}];break}c.keyData=d;c.showSeals(b)}else c.errorCallback(d,a.errorCall)},errorCall:function(b){c.errorCallback(b,
a.errorCall)}}))},run:function(a){var b=this;b.keyData?b.showSeals(a):(v.showLoading(),void 0!==a.beginCall&&a.beginCall&&a.beginCall.call(b),b.sealService.loadSeal({successCall:function(c){v.hideLoading();c.result?c.seals&&c.seals.length?(b.keyData=c,void 0!==d.options.imgtag&&0!==d.options.imgtag&&void 0===c.ServerTime?void 0!==b.serverUrl&&null!==b.serverUrl?(c={usercode:b.usercode,keysn:b.keyData.keysn,signname:b.signname,authcode:d.authcode},k.surry(b.serverUrl).request("/key/load",c).ret(function(c){c.result?
(b.curDate=c.ServerTime,b.keyData=c,b.showSeals(a)):b.errorCallback(c,a.errorCall)})):(b.curDate=(new Date).toLocaleString(),b.showSeals(a)):(b.curDate=c.ServerTime,b.showSeals(a))):b.errorCallback({errcode:"11100"+d.options.imgtag},a.errorCall):b.errorCallback(c,a.errorCall)},errorCall:function(c){b.errorCallback(c,a.errorCall)}}));return this},getSealsByKeysn:function(a,b,c){var d=this;d.sealService.loadSeal({successCall:function(a){if(a.result){var c=[];if(void 0!==b&&null!=b){for(var f=0;f<a.seals.length;++f)c[f]=
d.toBase64Img(a.seals[f]);b(c)}}},errorCall:function(a){d.errorCallback(a,c.errorCall)}})},loadSeals:function(a,b){var c=this;c.sealService.loadSeal({successCall:function(b){void 0!==a&&null!==a&&null!==b&&void 0!==b.seals&&null!==b.seals&&a(b)},errorCall:function(a){c.errorCallback(a,b&&b.errorCall?b.errorCall:null)}})},runSS:function(a,b){var c=this;if(null!==b)if(c.keyData=b,null==b.seals||0==b.seals.length)c.errorCallback({errcode:"11107"},a.errorCall);else if(void 0!==d.options.imgtag&&0!==d.options.imgtag&&
void 0===b.ServerTime)if(void 0!==c.serverUrl&&null!==c.serverUrl){var f={usercode:c.usercode,keysn:c.keyData.keysn,signname:c.signname,authcode:d.authcode};k.surry(c.serverUrl).request("/key/load",f).ret(function(b){b.result?(c.curDate=b.ServerTime,c.keyData=b,c.showSeals(a)):c.errorCallback(b,a.errorCall)})}else c.curDate=(new Date).toLocaleString(),c.showSeals(a);else c.curDate=b.ServerTime,c.showSeals(a)},formatPos:function(a,b,c){var d={};if(a){var m=function(a){var f=a.elemid||a[0].id;f||(f=
"body");d[f]=void 0!=b&&void 0!=c?{marginLeft:b,marginTop:c}:e.filter(a,f)};if(e.is("Array",a))for(var h=0;h<a.length;h++)m(a[h]);else e.is("String",a)?d[a]=void 0!=b&&void 0!=c?{marginLeft:b,marginTop:c}:{}:m(a)}else d.body={};return d},exec:function(a,b,c,f,m,h){var k=this;delete k.signatureData;var p={timestamp:{time:void 0==a.signtime?(new Date).getTime():(new Date(Date.parse(a.signtime.replace(/-/g,"/")))).getTime(),signtime:void 0==a.showtime?a.signtime:a.showtime,timestampInfo:a.timestampInfo},
appname:navigator.userAgent,documentid:void 0==a.documentid?k.documentid:a.documentid,documentname:void 0==a.documentname?k.documentname:a.documentname,moveable:e["boolean"](a,"moveable",d.options.moveable),keysn:k.keyData.keysn,orgname:k.keyData.orgname,usercode:k.keyData.usercode,username:k.keyData.username||c.username,seal:c,protectedData:k.getProtectedData(a.protectedItems),sealType:a.sealType||k.sealType,extparam:a.extparam,ver:d.version,dateTime:a.datetime};k.signatureData=p;k.certService.sData=
k.signatureData;k.sealService.sData=k.signatureData;v.showLoading();var l=a.autoCert||k.autoCert,g=function(a){var b=k.signatureData;if(a&&a.position){if(a.offsetX&&a.offsetY)a.changeOffsetXY&&a.changeOffsetXY(a),b.position=k.formatPos(a.position,a.offsetX,a.offsetY);else if(a.changeOffsetXY){var f={width:Math.ceil(9600*parseFloat(c.width)/254),height:Math.ceil(9600*parseFloat(c.height)/254)},f=a.changeOffsetXY(f);b.position=k.formatPos(a.position,f.offsetX,f.offsetY)}else b.position=k.formatPos(a.position);
f=a.signatureid||k.genId();a&&a.scopePosition&&(void 0==d.options.extra&&(d.options.extra={}),d.options.extra[f]={scopePosition:a.scopePosition});b.timeid=(new Date).getTime();var e=(new d(f,b)).load(d.options);a.okCall&&(b={name:c.signname,height:c.height,width:c.width,imgdata:k.toBase64Img(c)},a.isBatchSignature?a.okCall.call(e,function(a){a||e.remove()},a.documentid):a.okCall.call(e,function(b){b?(k.trigger("createSignature",e,a.logMeta,l),e.show()):e.remove()},b));v.hideLoading()}else throw Error("no set position");
};if(l){k.getSignData(p);p=k.getH5SignData();if(a.signMeta)p[e.is("Array",a.signMeta)?"concat":"push"](a.signMeta);a.beforeSignCall&&a.beforeSignCall.call(k,p);m?"client"==d.options.sealType?k.runSign(p,f,function(d){d.result&&(g(a),h&&1<h.batchSignature.length&&(a.documentid=h.batchSignature[h.batchSignature.length-1].documentid,a.documentname=h.batchSignature[h.batchSignature.length-1].documentname,--h.batchSignature.length,k.exec(a,b,c,f,m,h)));b(d)}):k.runSign(p,f,function(c){c.result&&g(a);b(c)}):
k.runSign(p,f,function(c){c.result&&g(a);b(c)})}else m?g(a):k.sealService.verifyPwd({pwd:f,keysn:p.keysn,successCall:function(c){c.result&&g(a);b(c)}})},runPwd:function(a){var b=this;b.showPwdDialog({cancelCall:a.cancelCall,_onOk:function(c){d.options.showNoPW=!0;d.options.password=c;var f=this.find("#kg-remenberPwd").is(":checked");b.trigger("execSuccess",this,c,f);b.run(l.extend(a,{beginCancalCall:function(){d.options.showNoPW=!1;d.options.password=""}}))}})},showPwdDialog:function(a){var b=this,
c=a._onOk;b.showDialog("passwordTpl",{onCancel:a.cancelCall,onShow:function(){var a=this;b.trigger("showSealsDialog_PW",a);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onOk:function(){var a=this.find("#kg-password"),b=a.val();b?(c.call(this,b),this.remove()):v.alert(k.msg("in_pwd_msg","KG_MSG"),function(){a.focus()});return!1},content:function(){return e.template.apply(null,[v.template.passwordTpl])}})},getPassCheck:function(a,b,c){if(a&&1==a)return a;if(void 0===
c||!0===c||"auto"===c)try{return b.find("#kg-remenberPwd").is(":checked")}catch(f){}return!1},showSeals:function(a){var b=this,c={errorCall:a.errorCall,cancelCall:a.cancelCall,beginCancalCall:a.beginCancalCall,protectedItems:a.protectedItems,_onOk:function(c,f,e,h,m,l){var g=this,p=new v.kgFont(null==g.fontSel?null==b.signdate?{}:b.signdate:g.fontSel),r=g.isCheck;!1===d.options.showSealsDlg&&d.options.signdate&&d.options.signdate.ischeck&&(r=d.options.signdate.ischeck);a.datetime={isCheck:r,fontDate:p};
void 0!=h&&null!=h?(a.signtime=h,void 0!=m&&null!=m?(a.showtime=(h+" ("+m.TimeExt+")").replace(/-/g,"/"),a.showtime+=k.msg("timestamp_time","KG_MSG"),a.timestampInfo=m):(a.showtime=(new Date(Date.parse(h.replace(/-/g,"/")))).toLocaleString(),a.showtime+=k.msg("server_time","KG_MSG"))):(a.signtime=void 0,a.showtime=(new Date).toLocaleString(),a.showtime+=k.msg("local_time","KG_MSG"));l=b.getPassCheck(l,g,d.options.showSealsDlg);void 0===d.options.valid||null===d.options.valid||!1===d.options.valid?
a.batchSignature?b.sealService.verifyPwd({pwd:f,usercode:void 0==a.usercode?"":a.usercode,keysn:b.keyData.keysn,successCall:function(e){if(e.result){for(e=0;e<a.batchSignature.length&&(a.batchSignature[e].signtime=a.signtime,a.batchSignature[e].showtime=a.showtime,a.batchSignature[e].position=a.position,a.batchSignature[e].autoCert=a.autoCert,a.batchSignature[e].okCall=a.okCall,a.batchSignature[e].cancelCall=a.cancelCall,a.batchSignature[e].beginCall=a.beginCall,a.batchSignature[e].endCall=a.endCall,
a.batchSignature[e].protectedItems=a.protectedItems,a.batchSignature[e].datetime=a.datetime,a.batchSignature[e].offsetX=a.offsetX,a.batchSignature[e].offsetY=a.offsetY,a.batchSignature[e].changeOffsetXY=a.changeOffsetXY,a.batchSignature[e].isBatchSignature=!0,b.exec(a.batchSignature[e],function(c){c.result?void 0!==d.options.showNoPW||!0===d.options.showNoPW?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===d.options.showSealsDlg||!0===d.options.showSealsDlg||b.autoDlg)&&
b.trigger("execSuccess",g,f,l):b.errorCallback(c,a.errorCall)},c,f,!0,a),void 0!==a.batchSignature[e].endCall&&a.batchSignature[e].endCall&&a.batchSignature[e].endCall.call(b),"client"!=d.options.sealType||!a.autoCert);++e);void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b);(void 0===d.options.showSealsDlg||!0===d.options.showSealsDlg||b.autoDlg)&&g.remove()}else b.errorCallback(e,a.errorCall)}}):(b.exec(a,function(c){c.result?(void 0!==d.options.showNoPW||!0===d.options.showNoPW?
void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===d.options.showSealsDlg||!0===d.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",g,f,l),g.remove()):b.errorCallback(c,a.errorCall)},c,f),void 0!==a.endCall&&a.endCall&&a.endCall.call(b)):void 0!==b.curDate&&null!==b.curDate&&b.sealExpired(c,a,b.curDate,function(e){e?a.batchSignature?b.sealService.verifyPwd({pwd:f,keysn:b.keyData.keysn,successCall:function(e){if(e.result){for(e=0;e<a.batchSignature.length;++e)a.batchSignature[e].signtime=
a.signtime,a.batchSignature[e].showtime=a.showtime,a.batchSignature[e].position=a.position,a.batchSignature[e].autoCert=a.autoCert,a.batchSignature[e].okCall=a.okCall,a.batchSignature[e].cancelCall=a.cancelCall,a.batchSignature[e].beginCall=a.beginCall,a.batchSignature[e].endCall=a.endCall,a.batchSignature[e].protectedItems=a.protectedItems,a.batchSignature[e].datetime=a.datetime,a.batchSignature[e].offsetX=a.offsetX,a.batchSignature[e].offsetY=a.offsetY,a.batchSignature[e].changeOffsetXY=a.changeOffsetXY,
a.batchSignature[e].isBatchSignature=!0,b.exec(a.batchSignature[e],function(c){c.result?void 0!==d.options.showNoPW||!0===d.options.showNoPW?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===d.options.showSealsDlg||!0===d.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",g,f,l):b.errorCallback(c,a.errorCall)},c,f,!0),void 0!==a.batchSignature[e].endCall&&a.batchSignature[e].endCall&&a.batchSignature[e].endCall.call(b);void 0!==a.beginCancalCall&&a.beginCancalCall&&
a.beginCancalCall.call(b);(void 0===d.options.showSealsDlg||!0===d.options.showSealsDlg||b.autoDlg)&&g.remove()}else b.errorCallback(e,a.errorCall)}}):(b.exec(a,function(c){c.result?(void 0!==d.options.showNoPW||!0===d.options.showNoPW?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===d.options.showSealsDlg||!0===d.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",g,f,l),g.remove()):b.errorCallback(c,a.errorCall)},c,f),void 0!==a.endCall&&a.endCall&&a.endCall.call(b)):
b.errorCallback({errcode:"11103"},a.errorCall)},e)}};if(void 0!==d.options.showSealsDlg){var f=!0;if("auto"==d.options.showSealsDlg){var e=b.keyData;e.seals&&1==e.seals.length&&(f=!1)}b.autoDlg=f;if(!1!==d.options.showSealsDlg&&f)this.showSealsDialog(c);else if(void 0===d.options.password&&void 0!==b.password&&(d.options.password=b.password),void 0===d.options.password)b.errorCallback({errcode:"11108"},a.errorCall);else if(void 0!=d.options.timestamp&&1==d.options.timestamp)if("client"==d.options.sealType){var h=
k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");h.invoke("KGGetTSURLInfo").ret(function(f){f.result?h.invoke("KGGetTSWithDigest",f.TimeStampUrl,f.TimeStampUserName,f.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(f){f.result?c._onOk.call(b,b.keyData.seals[0],d.options.password,0,f.TimeStr,f):(b.errorCallback(f,a.errorCall,"KGGetTSWithDigest"),c._onOk.call(b,e.seals[0],pwdVal,0))}):(b.errorCallback(f,a.errorCall,
"KGGetTSURLInfo"),c._onOk.call(b,e.seals[0],pwdVal,0))})}else l.ajax({url:d.options.serverUrl+"/key/getTimeStamp",data:{keysn:b.keyData.keysn},async:!1,success:function(a){a.result?c._onOk.call(b,b.keyData.seals[0],d.options.password,0,a.timestamp):c._onOk.call(b,b.keyData.seals[0],d.options.password,0)},error:function(a){c._onOk.call(b,b.keyData.seals[0],d.options.password,0)}});else c._onOk.call(b,b.keyData.seals[0],d.options.password,0)}else this.showSealsDialog(c)},showSealsDialog:function(a){var b=
this,c=b.keyData;null!=b.signdate&&(c.signDateIsCheck=b.signdate.ischeck);var f=[c],m=a._onOk,h=a.beginCancalCall,g={onCancel:a.cancelCall,onShow:function(){var a=this,c=a.find(".kg-switcher");if(c.length){var f=new e.Switcher(c[0],b.switcher||{});l(".arrow-right").click(function(a){a.preventDefault();f.swipeNext()});l(".arrow-left").click(function(a){a.preventDefault();f.swipePrev()});l(".kg-guide span").click(function(a){a.preventDefault();f.to(+this.getAttribute("index"))});b.switcher=f}a.find("#kg-dateSet").click(function(c){b.showFontDialog(a)});
b.trigger("showSealsDialog",a);d.options.showNoPW||b.trigger("showSealsDialog_PW",a);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onOk:function(){var f=this,e=f.find("#kg-password"),h=e.val()||d.options.password;if(!h)return v.alert(k.msg("in_pwd_msg","KG_MSG"),function(){setTimeout(function(){e.focus()},100)}),!1;var g=f.find(".kg-wrapper .active");f.isCheck=f.find("#kg-addDate").is(":checked");var r=f.find("#kg-remenberPwd").is(":checked");if("client"==d.options.sealType&&
b.keyData.seals[g.attr("index")].SealTag&&"GM"==b.keyData.seals[g.attr("index")].SealTag){var n=k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");n.invoke("KGValidate_GM","",b.keyData.seals[g.attr("index")].SealCert,b.keyData.seals[g.attr("index")].ValidStart,b.keyData.seals[g.attr("index")].ValidEnd,b.keyData.seals[g.attr("index")].CertList,"").ret(function(e){if(e.result)if(void 0!=d.options.timestamp&&1==d.options.timestamp){var l=k.surry(d.options.clientUrl,
"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");l.invoke("KGGetTSURLInfo").ret(function(d){d.result?l.invoke("KGGetTSWithDigest",d.TimeStampUrl,d.TimeStampUserName,d.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(d){d.result?m.call(f,c.seals[g.attr("index")],h,g.attr("index"),d.TimeStr,d,r?!0:!1):(b.errorCallback(d,a.errorCall,"KGGetTSWithDigest"),m.call(f,c.seals[g.attr("index")],h,g.attr("index"),void 0,void 0,r?!0:!1))}):(b.errorCallback(d,
a.errorCall,"KGGetTSWithDigest"),m.call(f,c.seals[g.attr("index")],h,g.attr("index"),void 0,void 0,r?!0:!1))})}else m.call(f,c.seals[g.attr("index")],h,g.attr("index"),void 0,void 0,r?!0:!1);else return b.errorCallback(e,a.errorCall,"KGValidate_GM"),!1})}else return g=f.find(".kg-wrapper .active"),f.isCheck=f.find("#kg-addDate").is(":checked"),void 0!=d.options.timestamp&&1==d.options.timestamp?"client"==d.options.sealType?(n=k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319"),
n.invoke("KGGetTSURLInfo").ret(function(d){d.result?n.invoke("KGGetTSWithDigest",d.TimeStampUrl,d.TimeStampUserName,d.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(d){d.result?m.call(f,c.seals[g.attr("index")],h,g.attr("index"),d.TimeStr,d):(b.errorCallback(d,a.errorCall,"KGGetTSWithDigest"),m.call(f,c.seals[g.attr("index")],h,g.attr("index")))}):(b.errorCallback(d,a.errorCall,"KGGetTSURLInfo"),m.call(f,c.seals[g.attr("index")],h,g.attr("index")))})):
l.ajax({url:d.options.serverUrl+"/key/getTimeStamp",data:{keysn:b.keyData.keysn},async:!1,success:function(a){a.result?m.call(f,c.seals[g.attr("index")],h,g.attr("index"),a.timestamp):m.call(f,c.seals[g.attr("index")],h,g.attr("index"))},error:function(a){m.call(f,c.seals[g.attr("index")],h,g.attr("index"))}}):m.call(f,c.seals[g.attr("index")],h,g.attr("index")),!1},content:function(){f.push(b.toBase64Img);var a=[d.options.template.showSealsBtl].concat(f);d.options.showNoPW&&(a=[d.options.template.showSealsBtl_nopassword].concat(f));
return e.template.apply(null,a)}};void 0!==h&&h&&(g=e.extend({onCancel:function(){void 0!==h&&h&&h.call(b);this.close()}},g));d.options.showNoPW?b.showDialog("showSealsBtl_nopassword",g):b.showDialog("showSealsBtl",g)},showFontDialog:function(a){var b=this,c=v.dafaultDate,f=null==b.signdate?{}:b.signdate,g=v.defaultFont,b=this,b=null==f.fontFormat?g.fontFormat:f.fontFormat,h=null==f.fontFamily?g.fontFamily:f.fontFamily,r=null==f.fontSize?g.fontSize:f.fontSize,p=g.fontColor;null!=f.fontColor&&/^#([0-9a-fA-f]{6})$/.test(f.fontColor)&&
(p=f.fontColor.toUpperCase());f=null==f.position?g.position:f.position;null!=a.fontSel&&(b=a.fontSel.fontFormat,h=a.fontSel.fontFamily,r=a.fontSel.fontSize,p=a.fontSel.fontColor,f=v.fontTemplate.position[a.fontSel.fontPositionIndex]);var n=this.getArrayPush(d.options.fontTemplate.fontFormat,b),t=[{fontFormat:this.getFormatDate(n,c),fontFamily:this.getArrayPush(d.options.fontTemplate.fontFamily,h),fontSize:this.getArrayPush(d.options.fontTemplate.fontSize,r),fontColor:this.getArrayPush(d.options.fontTemplate.fontColor,
p),fontPosition:d.options.fontTemplate.position,dFontFormat:k.Utils.formatDate(new Date(c),b),dFontFamily:h,dFontSize:r,dFontColor:p,dFontPosition:f}],c={title:k.msg("DateSet","KG_TITLE"),content:function(){var a=[d.options.template.dateSetBtl].concat(t);return e.template.apply(null,a)},onOk:function(){var b=this.find("#kg-fontFormat").get(0).selectedIndex;a.fontSel={fontFormat:n[b],fontFamily:this.find("#kg-fontFamily").val(),fontSize:this.find("#kg-fontSize").val(),fontColor:k.Utils.colorHex(this.find("#kg-select-color").css("backgroundColor")),
fontPositionIndex:this.find("#kg-fontPosition").get(0).selectedIndex}}},q=v.showDialog("dateSetBtl",c);q.find("#kg-select-color").on("click",function(){q.find(".kg-color-div").css("display","block");q.find("#kg-color-ul").css("display","block")});q.find("#kg-color-ul li a").click(function(){l("#kg-select-color").css("backgroundColor",l(this).css("backgroundColor"));q.find(".kg-color-div").css("display","none");q.find("#kg-color-ul").css("display","none")});q.find(".kg-color-div").on("mouseover",function(a){this.contains(a.fromElement||
a.relatedTarget)||l(this).show()});q.find(".kg-color-div").on("mouseout",function(a){this.contains(a.toElement||a.relatedTarget)||l(this).hide()});return q},getArrayPush:function(a,b){-1==jQuery.inArray(b,a)&&a.push(b);return a},getFormatDate:function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=k.Utils.formatDate(new Date(b),a[d]);return c},genId:function(){var a=(new Date).getTime(),b=""+Math.ceil((9301*(new Date).getTime()+49297)%233280/233280*99999),c=5-b.length;if(0<c)for(var d=0;d<c;d++)b="0"+
b;return a+b},getSeal:function(a){return this.keyData.seals[a]},saveSignature:function(a,b,c,f){var e=this;void 0!=a&&void 0!=b&&void 0!=c&&(a=void 0!=d.options.cache_path&&null!=d.options.cache_path?{documentId:a,signatureId:b,signaturedata:c,cachepath:d.options.cache_path}:{documentId:a,signatureId:b,signaturedata:c,cachepath:""},k.surry(d.options.serverUrl).request("/signature/saveHtmlSignature",a).ret(function(a){void 0!==f&&null!==f&&f.call(e,a)}))},removeSignature:function(a,b,c){var f=this;
void 0!=a&&void 0!=b&&(a={documentId:a,signatureId:b},k.surry(d.options.serverUrl).request("/signature/reomveHtmlSignature",a).ret(function(a){void 0!==c&&null!==c&&c.call(f,a)}))},getSaveSignatures:function(a,b){void 0!=a&&k.surry(d.options.serverUrl).request("/signature/getHtmlSignature",{documentId:a}).ret(function(a){a.result&&b(a.sign)})}});l.extend(d.options,{certType:"client",sealType:"client",clientUrl:"http://127.0.0.1:9581",moveable:!0,signable:!0,fontTemplate:v.fontTemplate,template:{showSealsBtl:v.template.sealTpl,
showSealsBtl_nopassword:v.template.sealTpl_nopassword,signSignatureBtl:'<div id="kg-dialog-sign" class="kg-dialog kg-dialog-password kg-dialog-sign"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u5bc6\u7801\uff1a</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div> </div></div></div>',revokeSignatureBtl:'<div id="kg-verifyPass" class="kg-dialog  kg-dialog-password"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u7b7e\u7ae0\uff1a</label><div class="kg-sm kg-sm-7"><p class="kg-form-static"><%this.signatureData.seal.signname%></p></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u5bc6\u7801\uff1a</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div> </div></div></div>',
dateSetBtl:'<div id="kg-setDate" class="kg-dialog kg-dialog-Date"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u683c\u5f0f\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontFormat" id="kg-fontFormat" class="kg-select kg-fontFormat"><% var fontFormat = this.fontFormat; %><% for(var i=0;i<fontFormat.length;i++) {%><% if(fontFormat[i] == this.dFontFormat){%><option class="kg-option" value="<% fontFormat[i]%>" selected><% fontFormat[i]%></option><%}else{%><option class="kg-option" value="<% fontFormat[i]%>"><% fontFormat[i]%></option><%}%><%}%></select></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u5b57\u4f53\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontFamily" id="kg-fontFamily" class="kg-select kg-fontFamily"><% var fontFamily = this.fontFamily; %><% for(var i=0;i<fontFamily.length;i++) {%><% if(fontFamily[i] == this.dFontFamily){%><option class="kg-option" value="<% fontFamily[i]%>" selected><% fontFamily[i]%></option><%}else{%><option class="kg-option" value="<% fontFamily[i]%>"><% fontFamily[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u5c3a\u5bf8\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontSize" id="kg-fontSize" class="kg-select kg-fontSize"><% var fontSize = this.fontSize; %><% for(var i=0;i<fontSize.length;i++) {%><% if(fontSize[i] == this.dFontSize){%><option class="kg-option" value="<% fontSize[i]%>" selected><% fontSize[i]%></option><%}else{%><option class="kg-option" value="<% fontSize[i]%>"><% fontSize[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u989c\u8272\uff1a</label><div class="kg-sm kg-sm-6"><% var fontColor = this.fontColor; %><div id="kg-select-color" class="kg-select-color" style="background-color:<% this.dFontColor%>"/><div class="kg-color-div"><ul class="kg-color-ul" id="kg-color-ul"><% for(var i=0;i<fontColor.length;i++){ %><li class="kg-color-li"><a href="javascript:;" style="background-color:<% fontColor[i]%>"></a></li><%}%></ul></div></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u4f4d\u7f6e\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontPosition" id="kg-fontPosition" class="kg-select kg-fontPosition"><% var fontPosition = this.fontPosition; %><% for(var i=0;i<fontPosition.length;i++) {%><% if(fontPosition[i] == this.dFontPosition){%><option class="kg-option" value="<% fontPosition[i]%>" selected><% fontPosition[i]%></option><%}else{%><option class="kg-option" value="<% fontPosition[i]%>"><% fontPosition[i]%></option><%}%><%}%></select></div> </div></div></div>'}});
d.list={};d.updateList=[];d.removeList=[];d.loadSignature=function(a,b,c,f){var e={};void 0==d.options.extra&&(d.options.extra={});e[a]=b;void 0!==e.extra&&null!==e.extra&&(d.options.extra[e.signatureid]=e.extra);u(e,c||function(a){a.verify()},f)};d.loadSignatures=function(a,b,c){var f={};void 0==d.options.extra&&(d.options.extra={});if(e.is("Array",a))for(var g=0;g<a.length;g++){var h=a[g];f[h.signatureid]=h.signatureData;void 0!==h.extra&&null!==h.extra&&(d.options.extra[h.signatureid]=h.extra)}else for(g in a)f[g]=
a[g];u(f,b||function(){d.verify()},c)};d.resetSignaturePos=function(a){void 0==d.options.extra&&(d.options.extra={});if(e.is("Array",a))for(var b=0;b<a.length;b++){var c=a[b];void 0!==c.extra&&null!==c.extra&&(d.options.extra[c.signatureid]=c.extra)}else for(b in a)d.options.extra[b]=a[b]};d.clearRPW=function(){delCookie("ksn");delCookie("pwd");delCookie("ck")};var z=new g("Signature");d.addLiseter=function(a,b){z.on(a,b)};d.verify=function(){var a=d.list,b=[];z.trigger("beforeVerify",f);for(var c in a){var f=
a[c];f._verify(null,{batchVerify:!0})||b.push(f);z.trigger("eachVerify",f)}z.trigger("verify",f);return b};d.verifySignByList=function(a){var b=[];z.trigger("beforeVerify",d);for(var c in a){var d=a[c],e=d._verify(null,{batchVerify:!0}),h=d.signatureData,g={};g.appname=h.appname;g.documentid=h.documentid;g.documentname=h.documentname;g.keysn=h.keysn;g.orgname=h.orgname;g.timestamp=h.timestamp;g.usercode=h.usercode;g.username=h.username;g.signname=h.seal.signname;g.signsn=h.seal.signsn;e||(g.modifiedItems=
d.modifiedItems);b.push(g);z.trigger("eachVerify",d)}z.trigger("verify",d);return b};d.bind=function(a){e.extend(d.asyn,a)};d.show=function(){var a=d.list,b;for(b in a)a[b].show()};d.hide=function(){var a=d.list,b;for(b in a)a[b].hide()};d.AXI=function(a,b,c){d.authcode=g;var f=k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319"),e;for(e in b){var g=b[e];""!==e&&""!==g?f.invoke(a,e,g):null!==e&&""!==e?f.invoke(a,e):f.invoke(a)}f.ret(function(a){a.result&&
(d.options.moveable_self?f.invoke("KGGetKeyOtherInfo","0").ret(function(b){b.result&&(b=b.Res.substring(1,b.Res.length-1),d.options.keysn=b);void 0!==c&&null!==c&&c(a)}):void 0!==c&&null!==c&&c(a))});return f};d.showAndHideBySignatureId=function(a,b){var c=d.list,f;for(f in c)0<=f.indexOf(a)&&(b?c[f].show():c[f].hide())};d.addIcon=function(a){var b=d.options.icons||[];b.push(a);d.options.icons=b};d.create=function(a){var b=l.extend({},d.options,a);void 0!==a&&void 0!==a.imgtag&&(d.options.imgtag=
a.imgtag);return new d._create(b)};l.extend(d.prototype,{saveSignatures:function(){},getSignatures:function(){}});g=function(a){var b=this;l.each(a,function(a,d){if("function"===typeof b[a])b[a](d);else b[a]=d})};e.inherit(g,d.SealService);w=function(a){var b=this;l.each(a,function(a,d){if("function"===typeof b[a])b[a](d);else b[a]=d})};e.inherit(w,d.CertService);l.extend(g.prototype,{saveLog:function(a){var b=[];e.is("Object",a)?b.push(a):b=a;a=n({MSG:b});k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1",
"4240FB41-A213-42B6-8CB5E6705C99B319").invoke("SetParamByName","SAVEMSG",a)},loadSeal:function(a){var b=this,c=a.successCall,e=a.errorCall,g=k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");b.appcode?g.invoke("SetParamByName","APPCODE",b.appcode):b.appcode="";g.invoke("KGGetKeyInfo").ret(function(f){if(f.result){if(""==f.seals)if(null!=a.data)f.seals={},f.seals[0]={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"};else{e.call(b,{result:!1,
errcode:"11"});return}else if(void 0!==d.options.imgtag&&null!==d.options.imgtag&&0!==d.options.imgtag){var g=[],h;for(h in f.seals){var k=f.seals[h];void 0!==k&&parseInt(k.imgtag)==d.options.imgtag&&(g[g.length]=f.seals[h])}f.seals=g}c.call(b,f)}else e.call(b,f)})},verifyPwd:function(a){var b=this,c=a.successCall;k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGVerifyPin",a.pwd,a.keysn).ret(function(a){c.call(b,a)})},getKeysn:function(a,b){k.surry(d.options.clientUrl,
"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGGetKeyOtherInfo","0").ret(function(a){a.result?(a=a.Res.substring(1,a.Res.length-1),b(a)):v.alert(k.msg(a))})}});l.extend(w.prototype,{verifySign:function(a){var b=this,c=a.successCall;k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGVerifySignMessage","123456",a.signdata,a.signeddata).ret(function(a){c.call(b,a.result||"-8"!==a.errcode?a:{result:!1})})},parseDate:function(a){var b=
new Date;b.setFullYear(a.substring(0,4),+a.substring(4,6)-1,a.substring(6,8));b.setHours(a.substring(8,10),a.substring(10,12),a.substring(12,14),0);return b.getTime()},sign:function(a){for(var b=this,c=a.successCall,e=a.signMeta,g=[],h=[],n=0;n<e.length;n++){var p=e[n];g.push(p.signdata);h.push(""+p.signdata.length)}k.surry(d.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGCrySignMessage",a.password,g.join(";"),+h[0]).ret(function(a){a=l.extend({},
a);a.result&&(a.certinfo.notAfter=b.parseDate(a.certinfo.notAfter),a.certinfo.notBefore=b.parseDate(a.certinfo.notBefore));c.call(b,a)})}});d.addProvider("cert","client",w);d.addProvider("seal","client",g);g=function(a,b){var c=this;c.sData=b;l.each(a,function(a,b){if("function"===typeof c[a])c[a](b);else c[a]=b})};e.inherit(g,d.SealService);var J=function(a,b){var c=this;c.sData=b;l.each(a,function(a,b){if("function"===typeof c[a])c[a](b);else c[a]=b})};e.inherit(J,d.CertService);l.extend(g.prototype,
{getSealsUrl:"/key/load",verifyPwdUrl:"/key/verify",saveLogUrl:"/signature/saveLog",saveLog:function(a){a=n(a);k.surry(this.serverUrl).request(this.saveLogUrl,{loginfo:a}).ret(function(a){a.result||d.prototype.error.call(null,a)})},getPwdSaveTime:function(a,b){k.surry(d.options.serverUrl).request("/signature/getPwdSaveTime").ret(function(c){a(c.result?c.pwdTime:b)})},loadSeal:function(a){var b=this,c=a.successCall,e=a.errorCall,g={usercode:b.usercode,keysn:b.keysn,signname:b.signname,authcode:b.authcode,
password:d.options.password,sealTag:d.options.sealTag};k.surry(b.serverUrl).request(b.getSealsUrl,g).ret(function(f){if(f.result){if(""==f.seals)if(null!=a.data)f.seals={},f.seals[0]={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"};else{e.call(b,{result:!1,errcode:"11101"});return}else if(void 0!==d.options.imgtag&&null!==d.options.imgtag&&0!==d.options.imgtag){var g=[],h;for(h in f.seals){var k=f.seals[h];void 0!==k&&parseInt(k.imgtag)==d.options.imgtag&&(g[g.length]=f.seals[h])}f.seals=
g}c.call(b,f)}else e.call(b,f)})},verifyPwd:function(a){var b=this,c=a.successCall;a={usercode:void 0==b.sData?a.usercode:b.sData.usercode,keysn:void 0==b.sData?a.keysn:b.sData.keysn,password:a.pwd};k.surry(b.serverUrl).request(b.verifyPwdUrl,a).ret(function(a){c.call(b,a)})}});l.extend(J.prototype,{signUrl:"/sign",verifySignUrl:"/sign/verify",verifySign:function(a){var b=this,c=b.sData,d=a.successCall;k.surry(b.serverUrl).request(b.verifySignUrl,{certType:c.certType,isUTF8:c.isUTF8,signsn:c.seal.signsn,
html2sign:c.signMeta.html2sign,keysn:c.keysn,signsn:c.seal.signsn,signdata:a.signdata,signeddata:c.signMeta.signeddata,crtdata:c.signMeta.certinfo.crtdata}).ret(function(a){d.call(b,a)})},sign:function(a){for(var b=this,c=a.signMeta,d=a.successCall,e=[],g=0;g<c.length;g++){var l=c[g];e.push("$"+(l.hashAlg||b.hashAlg)+"|"+(l.encryptAlg||b.encryptAlg)+"$"+l.signdata)}a={keysn:a.keysn,password:a.password,signdata:e.join(";"),signsn:a.signsn};k.surry(b.serverUrl).request(b.signUrl,a).ret(function(a){a.result&&
(a.certinfo.algName=a.certinfo.algName.replace("with",""));d.call(b,a)})}});d.addProvider("cert","server",J);d.addProvider("seal","server",g);d.alert=v.alert;var Q=d.version={name:"1.0.20",code:100};return t.Signature=d});
// V1.0.0.340    
//# sourceMappingURL=c:/signature.min.map
